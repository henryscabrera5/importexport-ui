{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/jseyoum21/Downloads/importexport-ui-main/lib/services/usitc-api.ts"],"sourcesContent":["/**\n * USITC Dataweb API Service\n * Handles HTS code lookups using the USITC Dataweb API\n */\n\nimport { GoogleGenerativeAI } from \"@google/generative-ai\"\n\nconst USITC_API_KEY = process.env.USITC_DATAWEB_API_KEY\nconst GEMINI_API_KEY = process.env.GEMINI_API_KEY\nconst BASE_URL = \"https://datawebws.usitc.gov/dataweb\"\n\nconst genAI = GEMINI_API_KEY ? new GoogleGenerativeAI(GEMINI_API_KEY) : null\n\nexport interface HtsCodeResult {\n  code: string\n  description: string\n  confidence?: number\n}\n\n// In-memory cache for HTS code lookups\nconst htsCache = new Map<string, HtsCodeResult[]>()\n\n/**\n * Normalize description for caching (lowercase, trim, remove extra spaces)\n */\nfunction normalizeDescription(description: string): string {\n  return description.toLowerCase().trim().replace(/\\s+/g, \" \")\n}\n\n/**\n * Extract key search terms from a product description\n * Removes dimensions, measurements, and common words to get to the core product\n */\nfunction extractSearchTerms(description: string): string {\n  // Remove common measurement patterns (e.g., \"500 X 100 X 100MM\", \"500mm\", etc.)\n  let cleaned = description\n    .replace(/\\d+\\s*[Xx√ó]\\s*\\d+\\s*[Xx√ó]\\s*\\d+\\s*[Mm]{2}/gi, \"\") // Dimensions like \"500 X 100 X 100MM\"\n    .replace(/\\d+\\s*[Mm]{2}/gi, \"\") // Standalone measurements like \"500MM\"\n    .replace(/\\d+\\s*[Xx√ó]\\s*\\d+/gi, \"\") // Simple dimensions like \"500 X 100\"\n    .replace(/\\d+\\s*[Cc][Mm]/gi, \"\") // Centimeters\n    .replace(/\\d+\\s*[Ii][Nn]/gi, \"\") // Inches\n    .replace(/\\d+\\s*[Ff][Tt]/gi, \"\") // Feet\n  \n  // Remove extra spaces and trim\n  cleaned = cleaned.replace(/\\s+/g, \" \").trim()\n  \n  // If the cleaned description is too short or empty, use the original\n  if (cleaned.length < 3) {\n    return description.trim()\n  }\n  \n  return cleaned\n}\n\n/**\n * Build the USITC Dataweb API query for HTS code lookup\n */\nfunction buildHtsLookupQuery(description: string) {\n  return {\n    savedQueryName: \"\",\n    savedQueryDesc: \"\",\n    isOwner: true,\n    runMonthly: false,\n    reportOptions: {\n      tradeType: \"Import\",\n      classificationSystem: \"HTS\",\n    },\n    searchOptions: {\n      MiscGroup: {\n        districts: {\n          aggregation: \"Aggregate District\",\n          districtGroups: {\n            userGroups: [],\n          },\n          districts: [],\n          districtsExpanded: [\n            {\n              name: \"All Districts\",\n              value: \"all\",\n            },\n          ],\n          districtsSelectType: \"all\",\n        },\n        importPrograms: {\n          aggregation: null,\n          importPrograms: [],\n          programsSelectType: \"all\",\n        },\n        extImportPrograms: {\n          aggregation: \"Aggregate CSC\",\n          extImportPrograms: [],\n          extImportProgramsExpanded: [],\n          programsSelectType: \"all\",\n        },\n        provisionCodes: {\n          aggregation: \"Aggregate RPCODE\",\n          provisionCodesSelectType: \"all\",\n          rateProvisionCodes: [],\n          rateProvisionCodesExpanded: [],\n        },\n      },\n      commodities: {\n        aggregation: \"Aggregate Commodities\",\n        codeDisplayFormat: \"YES\",\n        commodities: [],\n        commoditiesExpanded: [],\n        commoditiesManual: description, // Use description for text-based search\n        commodityGroups: {\n          systemGroups: [],\n          userGroups: [],\n        },\n        commoditySelectType: \"search\", // Use \"search\" for text-based commodity lookup\n        granularity: \"6\", // 6-digit HTS code granularity\n        groupGranularity: null,\n        searchGranularity: null,\n      },\n      componentSettings: {\n        dataToReport: [\"CONS_FIR_UNIT_QUANT\"],\n        scale: \"1\",\n        timeframeSelectType: \"fullYears\",\n        years: [\"2023\", \"2024\"], // Recent years for current codes\n        startDate: null,\n        endDate: null,\n        startMonth: null,\n        endMonth: null,\n        yearsTimeline: \"Annual\",\n      },\n      countries: {\n        aggregation: \"Aggregate Countries\",\n        countries: [],\n        countriesExpanded: [\n          {\n            name: \"All Countries\",\n            value: \"all\",\n          },\n        ],\n        countriesSelectType: \"all\",\n        countryGroups: {\n          systemGroups: [],\n          userGroups: [],\n        },\n      },\n    },\n    sortingAndDataFormat: {\n      DataSort: {\n        columnOrder: [],\n        fullColumnOrder: [],\n        sortOrder: [],\n      },\n      reportCustomizations: {\n        exportCombineTables: false,\n        showAllSubtotal: true,\n        subtotalRecords: \"\",\n        totalRecords: \"20\", // Get more results for Gemini to rank, then return top 3\n        exportRawData: false,\n      },\n    },\n  }\n}\n\n/**\n * Extract column names from column groups (recursive helper)\n */\nfunction getColumns(columnGroups: any[], prevCols: string[] = []): string[] {\n  const columns = [...prevCols]\n  for (const group of columnGroups) {\n    if (group && typeof group === \"object\") {\n      if (Array.isArray(group.columns)) {\n        // Recursively process nested columns\n        getColumns(group.columns, columns)\n      } else if (group.label) {\n        // Found a column label\n        columns.push(group.label)\n      } else if (Array.isArray(group)) {\n        // If it's an array, process each item\n        getColumns(group, columns)\n      }\n    }\n  }\n  return columns\n}\n\n/**\n * Extract data values from rows\n */\nfunction getData(rows: any[]): any[][] {\n  const data: any[][] = []\n  for (const row of rows) {\n    if (row?.rowEntries && Array.isArray(row.rowEntries)) {\n      const rowData: any[] = []\n      for (const entry of row.rowEntries) {\n        rowData.push(entry?.value || \"\")\n      }\n      data.push(rowData)\n    }\n  }\n  return data\n}\n\n/**\n * Extract HTS codes and descriptions from USITC API response\n * Based on the USITC API documentation structure\n */\nfunction extractHtsCodesFromResponse(responseData: any): HtsCodeResult[] {\n  try {\n    const results: HtsCodeResult[] = []\n\n    // Navigate the nested response structure as per USITC API docs\n    const tables = responseData?.dto?.tables\n    if (!tables || !Array.isArray(tables) || tables.length === 0) {\n      return results\n    }\n\n    const table = tables[0]\n    const rowGroups = table?.row_groups\n    if (!rowGroups || !Array.isArray(rowGroups) || rowGroups.length === 0) {\n      return results\n    }\n\n    const rows = rowGroups[0]?.rowsNew\n    if (!rows || !Array.isArray(rows) || rows.length === 0) {\n      return results\n    }\n\n    // Extract column groups to understand structure\n    const columnGroups = table?.column_groups\n    if (!columnGroups || !Array.isArray(columnGroups)) {\n      return results\n    }\n\n    // Get all column labels\n    const columnLabels = getColumns(columnGroups)\n    \n    // Find indices for HTS code and description columns\n    let htsCodeIndex = -1\n    let descriptionIndex = -1\n\n    columnLabels.forEach((label, index) => {\n      const lowerLabel = label.toLowerCase()\n      if ((lowerLabel.includes(\"hts\") || lowerLabel.includes(\"code\") || lowerLabel.includes(\"classification\")) && htsCodeIndex === -1) {\n        htsCodeIndex = index\n      }\n      if ((lowerLabel.includes(\"description\") || lowerLabel.includes(\"commodity\") || lowerLabel.includes(\"product\")) && descriptionIndex === -1) {\n        descriptionIndex = index\n      }\n    })\n\n    // Extract data from rows\n    const rowData = getData(rows)\n\n    rowData.forEach((row) => {\n      if (!row || row.length === 0) return\n\n      let htsCode = \"\"\n      let description = \"\"\n\n      // Try to get from known column indices\n      if (htsCodeIndex >= 0 && row[htsCodeIndex]) {\n        htsCode = String(row[htsCodeIndex]).trim()\n      }\n      if (descriptionIndex >= 0 && row[descriptionIndex]) {\n        description = String(row[descriptionIndex]).trim()\n      }\n\n      // Fallback: search through all row values\n      if (!htsCode || !description) {\n        for (const value of row) {\n          const strValue = String(value || \"\").trim()\n          \n          // HTS codes match pattern: 4 digits.2 digits.4 digits (e.g., \"8471.30.0100\")\n          if (!htsCode && /^\\d{4}\\.\\d{2}\\.\\d{4}/.test(strValue)) {\n            htsCode = strValue\n          }\n          \n          // Description is typically longer text that doesn't start with numbers\n          if (!description && strValue.length > 15 && !/^\\d/.test(strValue) && !strValue.includes(\"$\")) {\n            description = strValue\n          }\n        }\n      }\n\n      // Only add if we have both code and description\n      if (htsCode && description) {\n        // Avoid duplicates\n        const exists = results.some((r) => r.code === htsCode)\n        if (!exists) {\n          results.push({\n            code: htsCode,\n            description: description,\n          })\n        }\n      }\n    })\n\n    return results\n  } catch (error) {\n    console.error(\"Error extracting HTS codes from response:\", error)\n    return []\n  }\n}\n\n/**\n * Use Gemini AI to rank HTS codes by relevance to the item description\n * Returns top 3 most relevant matches\n */\nasync function rankHtsCodesWithGemini(\n  itemDescription: string,\n  htsCodeOptions: HtsCodeResult[],\n): Promise<HtsCodeResult[]> {\n  if (!genAI || htsCodeOptions.length === 0) {\n    // If Gemini is not available, just return first 3\n    return htsCodeOptions.slice(0, 3)\n  }\n\n  if (htsCodeOptions.length <= 3) {\n    // If we have 3 or fewer, no need to rank\n    return htsCodeOptions\n  }\n\n  try {\n    const model = genAI.getGenerativeModel({ model: \"gemini-2.0-flash-exp\" })\n\n    const prompt = `You are an expert at matching product/item descriptions to HTS (Harmonized Tariff Schedule) codes.\n\nItem Description: \"${itemDescription}\"\n\nHTS Code Options:\n${htsCodeOptions\n  .map((option, index) => `${index + 1}. HTS Code: ${option.code}\\n   Description: ${option.description}`)\n  .join(\"\\n\\n\")}\n\nTask: Analyze each HTS code option and rank them by how closely they match the item description. Consider:\n- How well the HTS code description matches the item description\n- The specificity and accuracy of the match\n- Whether the HTS code is appropriate for the item type\n\nReturn ONLY a JSON array with the indices (1-based) of the top 3 most relevant HTS codes, ordered from most relevant to least relevant.\n\nFormat: [1, 5, 3] (where numbers are the 1-based indices from the list above)\n\nReturn ONLY the JSON array, no other text.`\n\n    const result = await model.generateContent(prompt)\n    const response = await result.response\n    const text = response.text().trim()\n\n    // Parse the JSON response\n    let rankedIndices: number[] = []\n    try {\n      const jsonMatch = text.match(/\\[[\\d\\s,]+\\]/)\n      if (jsonMatch) {\n        rankedIndices = JSON.parse(jsonMatch[0])\n      } else {\n        // Fallback: try to parse the whole response\n        rankedIndices = JSON.parse(text)\n      }\n    } catch (parseError) {\n      console.error(\"Error parsing Gemini ranking response:\", parseError)\n      // Fallback to first 3\n      return htsCodeOptions.slice(0, 3)\n    }\n\n    // Convert 1-based indices to 0-based and get the ranked results\n    const rankedResults: HtsCodeResult[] = []\n    for (const index of rankedIndices.slice(0, 3)) {\n      const zeroBasedIndex = index - 1\n      if (zeroBasedIndex >= 0 && zeroBasedIndex < htsCodeOptions.length) {\n        rankedResults.push(htsCodeOptions[zeroBasedIndex])\n      }\n    }\n\n    // If we didn't get 3 results, fill with remaining options\n    if (rankedResults.length < 3) {\n      for (const option of htsCodeOptions) {\n        if (!rankedResults.some((r) => r.code === option.code)) {\n          rankedResults.push(option)\n          if (rankedResults.length >= 3) break\n        }\n      }\n    }\n\n    return rankedResults.slice(0, 3)\n  } catch (error) {\n    console.error(\"Error ranking HTS codes with Gemini:\", error)\n    // Fallback to first 3 if Gemini ranking fails\n    return htsCodeOptions.slice(0, 3)\n  }\n}\n\n/**\n * Lookup HTS codes for a given item description\n * Returns top 3 most relevant matching HTS codes with descriptions\n * Uses Gemini AI to intelligently rank results by relevance\n */\nexport async function lookupHtsCodes(description: string): Promise<HtsCodeResult[]> {\n  if (!USITC_API_KEY) {\n    throw new Error(\"USITC Dataweb API key is not configured\")\n  }\n\n  if (!description || description.trim().length === 0) {\n    throw new Error(\"Description is required\")\n  }\n\n  // Check cache first\n  const normalizedDesc = normalizeDescription(description)\n  const cached = htsCache.get(normalizedDesc)\n  if (cached) {\n    return cached.slice(0, 3) // Return top 3 from cache\n  }\n\n  try {\n    // Extract key search terms from description (remove dimensions, etc.)\n    const searchTerms = extractSearchTerms(description)\n    console.log(\"Original description:\", description)\n    console.log(\"Extracted search terms:\", searchTerms)\n    \n    // Build query using cleaned search terms\n    const query = buildHtsLookupQuery(searchTerms)\n    console.log(\"USITC API Query structure:\", JSON.stringify(query, null, 2).substring(0, 1000))\n\n    // Make API request\n    console.log(\"Calling USITC API...\")\n    const response = await fetch(`${BASE_URL}/api/v2/report2/runReport`, {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json; charset=utf-8\",\n        Authorization: `Bearer ${USITC_API_KEY}`,\n      },\n      body: JSON.stringify(query),\n    })\n\n    if (!response.ok) {\n      const errorText = await response.text()\n      console.error(\"USITC API Error Response:\", errorText)\n      throw new Error(`USITC API error: ${response.status} ${response.statusText} - ${errorText}`)\n    }\n    \n    console.log(\"USITC API Response OK, parsing JSON...\")\n\n    const responseData = await response.json()\n\n    // Check for data load mode error\n    if (responseData.error && responseData.error.includes(\"data load mode\")) {\n      throw new Error(\"USITC Dataweb is currently in data load mode. Please try again later.\")\n    }\n\n    // Log response structure for debugging\n    console.log(\"USITC API Response status:\", response.status)\n    console.log(\"USITC API Response keys:\", Object.keys(responseData || {}))\n    if (process.env.NODE_ENV === \"development\") {\n      console.log(\"USITC API Full Response:\", JSON.stringify(responseData, null, 2).substring(0, 2000))\n    }\n\n    // Extract HTS codes from response\n    let results = extractHtsCodesFromResponse(responseData)\n    console.log(\"Extracted HTS codes count:\", results.length)\n\n    // If extraction didn't work, try alternative parsing\n    if (results.length === 0) {\n      // Try to extract from a simpler structure\n      const data = responseData?.dto?.tables?.[0]\n      if (data) {\n        // Look for any structured data that might contain HTS codes\n        const jsonString = JSON.stringify(data)\n        const htsCodeMatches = jsonString.match(/\\d{4}\\.\\d{2}\\.\\d{4}/g)\n        if (htsCodeMatches) {\n          // Create basic results from found codes\n          results = htsCodeMatches.map((code) => ({\n            code,\n            description: `HTS Code ${code}`,\n          }))\n        }\n      }\n    }\n\n    // If no results found, return empty array\n    if (results.length === 0) {\n      return []\n    }\n\n    // Use Gemini to intelligently rank and select top 3 most relevant matches\n    const topResults = await rankHtsCodesWithGemini(description, results)\n\n    // Cache the results\n    htsCache.set(normalizedDesc, topResults)\n\n    return topResults\n  } catch (error) {\n    console.error(\"Error looking up HTS codes:\", error)\n    throw error instanceof Error ? error : new Error(\"Failed to lookup HTS codes\")\n  }\n}\n\n/**\n * Clear the HTS code cache (useful for testing or forced refresh)\n */\nexport function clearHtsCache(): void {\n  htsCache.clear()\n}\n\n/**\n * Get cache statistics (useful for debugging)\n */\nexport function getCacheStats(): { size: number; keys: string[] } {\n  return {\n    size: htsCache.size,\n    keys: Array.from(htsCache.keys()),\n  }\n}\n\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 491, "column": 0}, "map": {"version":3,"sources":["file:///Users/jseyoum21/Downloads/importexport-ui-main/app/api/lookup-hts-codes/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\nimport { lookupHtsCodes } from \"@/lib/services/usitc-api\"\n\n/**\n * POST /api/lookup-hts-codes\n * Lookup HTS codes for a given item description using USITC Dataweb API\n * \n * Request body: { description: string }\n * Response: { htsCodes: Array<{ code: string, description: string }> }\n */\nexport async function POST(request: NextRequest) {\n  console.log(\"=\".repeat(80))\n  console.log(\"üöÄ API ROUTE HIT: /api/lookup-hts-codes\")\n  console.log(\"=\".repeat(80))\n  \n  try {\n    const body = await request.json()\n    const { description } = body\n\n    console.log(\"üì• API Route: Received lookup request for:\", description)\n    console.log(\"üì• API Route: Request body:\", JSON.stringify(body, null, 2))\n\n    if (!description || typeof description !== \"string\" || description.trim().length === 0) {\n      return NextResponse.json(\n        { error: \"Description is required and must be a non-empty string\" },\n        { status: 400 },\n      )\n    }\n\n    // Check if API key is configured\n    if (!process.env.USITC_DATAWEB_API_KEY) {\n      console.error(\"‚ùå API Route: USITC_DATAWEB_API_KEY is not set\")\n      return NextResponse.json(\n        { error: \"USITC Dataweb API key is not configured on the server\" },\n        { status: 500 },\n      )\n    }\n\n    console.log(\"‚úÖ API Route: API key is configured\")\n    console.log(\"üîç API Route: Calling lookupHtsCodes with description:\", description.trim())\n\n    // Lookup HTS codes (returns top 3)\n    const htsCodes = await lookupHtsCodes(description.trim())\n\n    console.log(\"‚úÖ API Route: Lookup completed, found\", htsCodes.length, \"codes\")\n    console.log(\"üì§ API Route: Returning response with\", htsCodes.length, \"HTS codes\")\n\n    return NextResponse.json({\n      htsCodes,\n      count: htsCodes.length,\n    })\n  } catch (error) {\n    console.error(\"=\".repeat(80))\n    console.error(\"‚ùå ERROR in lookup-hts-codes API:\", error)\n    console.error(\"‚ùå Error details:\", error instanceof Error ? error.stack : String(error))\n    console.error(\"=\".repeat(80))\n\n    // Handle specific error types\n    if (error instanceof Error) {\n      if (error.message.includes(\"API key is not configured\")) {\n        return NextResponse.json(\n          { error: \"USITC Dataweb API key is not configured\" },\n          { status: 500 },\n        )\n      }\n\n      if (error.message.includes(\"data load mode\")) {\n        return NextResponse.json(\n          { error: \"USITC Dataweb is currently in data load mode. Please try again later.\" },\n          { status: 503 },\n        )\n      }\n\n      if (error.message.includes(\"USITC API error\")) {\n        return NextResponse.json(\n          { error: \"Failed to query USITC Dataweb API\", message: error.message },\n          { status: 502 },\n        )\n      }\n    }\n\n    return NextResponse.json(\n      {\n        error: \"Failed to lookup HTS codes\",\n        message: error instanceof Error ? error.message : \"Unknown error\",\n      },\n      { status: 500 },\n    )\n  }\n}\n\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AASO,eAAe,KAAK,OAAoB;IAC7C,QAAQ,GAAG,CAAC,IAAI,MAAM,CAAC;IACvB,QAAQ,GAAG,CAAC;IACZ,QAAQ,GAAG,CAAC,IAAI,MAAM,CAAC;IAEvB,IAAI;QACF,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,EAAE,WAAW,EAAE,GAAG;QAExB,QAAQ,GAAG,CAAC,8CAA8C;QAC1D,QAAQ,GAAG,CAAC,+BAA+B,KAAK,SAAS,CAAC,MAAM,MAAM;QAEtE,IAAI,CAAC,eAAe,OAAO,gBAAgB,YAAY,YAAY,IAAI,GAAG,MAAM,KAAK,GAAG;YACtF,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAyD,GAClE;gBAAE,QAAQ;YAAI;QAElB;QAEA,iCAAiC;QACjC,IAAI,CAAC,QAAQ,GAAG,CAAC,qBAAqB,EAAE;YACtC,QAAQ,KAAK,CAAC;YACd,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAwD,GACjE;gBAAE,QAAQ;YAAI;QAElB;QAEA,QAAQ,GAAG,CAAC;QACZ,QAAQ,GAAG,CAAC,0DAA0D,YAAY,IAAI;QAEtF,mCAAmC;QACnC,MAAM,WAAW,MAAM,IAAA,mJAAc,EAAC,YAAY,IAAI;QAEtD,QAAQ,GAAG,CAAC,wCAAwC,SAAS,MAAM,EAAE;QACrE,QAAQ,GAAG,CAAC,yCAAyC,SAAS,MAAM,EAAE;QAEtE,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB;YACA,OAAO,SAAS,MAAM;QACxB;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,IAAI,MAAM,CAAC;QACzB,QAAQ,KAAK,CAAC,oCAAoC;QAClD,QAAQ,KAAK,CAAC,oBAAoB,iBAAiB,QAAQ,MAAM,KAAK,GAAG,OAAO;QAChF,QAAQ,KAAK,CAAC,IAAI,MAAM,CAAC;QAEzB,8BAA8B;QAC9B,IAAI,iBAAiB,OAAO;YAC1B,IAAI,MAAM,OAAO,CAAC,QAAQ,CAAC,8BAA8B;gBACvD,OAAO,gJAAY,CAAC,IAAI,CACtB;oBAAE,OAAO;gBAA0C,GACnD;oBAAE,QAAQ;gBAAI;YAElB;YAEA,IAAI,MAAM,OAAO,CAAC,QAAQ,CAAC,mBAAmB;gBAC5C,OAAO,gJAAY,CAAC,IAAI,CACtB;oBAAE,OAAO;gBAAwE,GACjF;oBAAE,QAAQ;gBAAI;YAElB;YAEA,IAAI,MAAM,OAAO,CAAC,QAAQ,CAAC,oBAAoB;gBAC7C,OAAO,gJAAY,CAAC,IAAI,CACtB;oBAAE,OAAO;oBAAqC,SAAS,MAAM,OAAO;gBAAC,GACrE;oBAAE,QAAQ;gBAAI;YAElB;QACF;QAEA,OAAO,gJAAY,CAAC,IAAI,CACtB;YACE,OAAO;YACP,SAAS,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QACpD,GACA;YAAE,QAAQ;QAAI;IAElB;AACF","debugId":null}}]
}